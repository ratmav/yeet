---
- hosts: void-hw
  tasks:
    - name: update packages
      apt:
        name: "*"
        state: latest
      become: yes

    - name: update development tools
      apt:
        name: build-essential
        state: latest
      become: yes

    - name: get kernel version
      shell: uname -r
      register: kernel

    - name: install kernel headers
      apt:
        name: "linux-headers-{{ kernel.stdout_lines[0] }}"
        state: latest
      become: yes

    - name: copy source
      copy:
        src: ../src
        dest: ~/

    - name: build module
      ansible.builtin.shell: make
      args:
        chdir: ~/src

      # TODO: necessary w/ reboot?
    - name: insert  module
      shell: insmod void_hw.ko
      args:
        chdir: /home/ratmav/src
      become: yes

    - name: copy module to lib
      copy:
        src: /home/ratmav/src/void_hw.ko
        dest: "/lib/modules/{{ kernel.stdout_lines[0] }}"
        remote_src: yes
      become: yes

    - name: add module to list
      lineinfile:
        path: /etc/modules
        line: void_hw
        create: yes
      become: yes

    - name: update module dependencies
      command: depmod
      become: yes

    - name: reboot
      reboot:
      become: yes

    # TODO: test by grepping dmesg for the yeet.
